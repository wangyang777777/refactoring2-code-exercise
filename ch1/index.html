<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script>
      let plays = {
        hamlet: { name: "Hamlet", type: "tragedy" },
        "as-like": { name: "As You Like It", type: "comedy" },
        othello: { name: "Othello", type: "tragedy" },
      };
      let invoices = [
        {
          customer: "BigCo",
          performances: [
            {
              playID: "hamlet",
              audience: 55,
            },
            {
              playID: "as-like",
              audience: 35,
            },
            {
              playID: "othello",
              audience: 40,
            },
          ],
        },
      ];
      function statement(invoice, plays) {
        let result = `Statement for ${invoice.customer}\n`;

        for (let perf of invoice.performances) {
          // print line for this order
          result += ` ${playFor(perf).name}: ${usd(amountFor(perf) / 100)} (${
            perf.audience
          } seats)\n`;
        }
        result += `Amount owed is ${usd(totalAmount() / 100)}\n`;
        result += `You earned ${totalVolumeCredits()} credits\n`;
        return result;

        function amountFor(aPerformance) {
          let result = 0;

          switch (playFor(aPerformance).type) {
            case "tragedy":
              result = 40000;
              if (aPerformance.audience > 30) {
                result += 1000 * (aPerformance.audience - 30);
              }
              break;
            case "comedy":
              result = 30000;
              if (aPerformance.audience > 20) {
                result += 10000 + 500 * (aPerformance.audience - 20);
              }
              result += 300 * aPerformance.audience;
              break;
            default:
              throw new Error(`unknown type: ${playFor(aPerformance).type}`);
          }
          return result;
        }
        function playFor(aPerformance) {
          return plays[aPerformance.playID];
        }
        function volumeCreditsFor(perf) {
          let result = 0;
          result += Math.max(perf.audience - 30, 0);
          // add extra credit for every ten comedy attendees
          if ("comedy" === playFor(perf).type)
            result += Math.floor(perf.audience / 5);
          return result;
        }
        function usd(aNumber) {
          return new Intl.NumberFormat("en-US", {
            style: "currency",
            currency: "USD",
            minimumFractionDigits: 2,
          }).format(aNumber);
        }
        function totalVolumeCredits() {
          let result = 0;
          for (let perf of invoice.performances) {
            result += volumeCreditsFor(perf);
          }
          return result;
        }
        function totalAmount() {
          let result = 0;
          for (let perf of invoice.performances) {
            result += amountFor(perf);
          }
          return result;
        }
      }

      let res = statement(invoices[0], plays);
      console.log(res);
    </script>
  </body>
</html>

<!-- 重构思路
1.中间的那段 switch，提炼到一个函数里，注意哪些变量会离开原来的作用域，其中包含thisAmout、play、perf
2. 将函数的返回值命名为 result
3. 参数取名时，使用不定冠词来标识变量的类型
4. 移出 play 变量，以查询取代临时变量
5. 移出 play 参数，首先在 amountFor 函数内部使用新提炼的函数 playFor
6. 内联变量手法替换 play 参数
7. 内联变量手法替换 thisAmount 变量
8. 将 volumeCredits 相关整段逻辑提炼到新函数中，直接返回 volumeCredits，同时返回的变量命名为 result
9. 移除 format 变量，典型的将函数赋值给临时变量的场景，更愿意将其替换为一个明确声明的函数
10. format 函数名语义不太明确，起名为 usd
11. 重构目标volumeCredits，拆分循环，将volumeCredits的累加过程分离出来，这样，变量声明就可以挪动到紧邻循环的位置
12. 对 volumeCredits 的计算过程提炼函数，再应用内联变量手法内联 totalVolumeCredits 函数
13. 重复同样的步骤来移除 totalAmmount 变量，下移变量声明语句，最后再提炼函数
 -->
