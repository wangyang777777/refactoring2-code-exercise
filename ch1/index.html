<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script>
      let plays = {
        hamlet: { name: "Hamlet", type: "tragedy" },
        "as-like": { name: "As You Like It", type: "comedy" },
        othello: { name: "Othello", type: "tragedy" },
      };
      let invoices = [
        {
          customer: "BigCo",
          performances: [
            {
              playID: "hamlet",
              audience: 55,
            },
            {
              playID: "as-like",
              audience: 35,
            },
            {
              playID: "othello",
              audience: 40,
            },
          ],
        },
      ];
      function statement(invoice, plays) {
        return renderPlainText(createStatementData(invoice, plays));
      }

      function createStatementData(invoice, plays) {
        const statementData = {};
        statementData.customer = invoice.customer;
        statementData.performances =
          invoice.performances.map(enrichperformance);
        statementData.totalAmount = totalAmount(statementData);
        statementData.totalVolumeCredits = totalVolumeCredits(statementData);
        return statementData;

        function enrichperformance(aPerformance) {
          const result = Object.assign({}, aPerformance);
          result.play = playFor(result);
          result.amount = amountFor(result);
          return result;
        }
        function playFor(aPerformance) {
          return plays[aPerformance.playID];
        }
        function amountFor(aPerformance) {
          let result = 0;

          switch (aPerformance.play.type) {
            case "tragedy":
              result = 40000;
              if (aPerformance.audience > 30) {
                result += 1000 * (aPerformance.audience - 30);
              }
              break;
            case "comedy":
              result = 30000;
              if (aPerformance.audience > 20) {
                result += 10000 + 500 * (aPerformance.audience - 20);
              }
              result += 300 * aPerformance.audience;
              break;
            default:
              throw new Error(`unknown type: ${aPerformance.play.type}`);
          }
          return result;
        }
        function volumeCreditsFor(aPerformance) {
          let result = 0;
          result += Math.max(aPerformance.audience - 30, 0);
          // add extra credit for every ten comedy attendees
          if ("comedy" === aPerformance.play.type)
            result += Math.floor(aPerformance.audience / 5);
          return result;
        }
        function totalAmount(data) {
          let result = 0;
          for (let perf of data.performances) {
            result += perf.amount;
          }
          return result;
        }
        function totalVolumeCredits(data) {
          let result = 0;
          for (let perf of data.performances) {
            result += volumeCreditsFor(perf);
          }
          return result;
        }
      }

      function renderPlainText(data, plays) {
        let result = `Statement for ${data.customer}\n`;

        for (let perf of data.performances) {
          // print line for this order
          result += ` ${perf.play.name}: ${usd(perf.amount / 100)} (${
            perf.audience
          } seats)\n`;
        }
        result += `Amount owed is ${usd(data.totalAmount / 100)}\n`;
        result += `You earned ${data.totalVolumeCredits} credits\n`;
        return result;

        function usd(aNumber) {
          return new Intl.NumberFormat("en-US", {
            style: "currency",
            currency: "USD",
            minimumFractionDigits: 2,
          }).format(aNumber);
        }
      }

      let res = statement(invoices[0], plays);
      console.log(res);
    </script>
  </body>
</html>

<!-- 重构思路
1.中间的那段 switch，提炼到一个函数里，注意哪些变量会离开原来的作用域，其中包含thisAmout、play、perf
2. 将函数的返回值命名为 result
3. 参数取名时，使用不定冠词来标识变量的类型
4. 移出 play 变量，以查询取代临时变量
5. 移出 play 参数，首先在 amountFor 函数内部使用新提炼的函数 playFor
6. 内联变量手法替换 play 参数
7. 内联变量手法替换 thisAmount 变量
8. 将 volumeCredits 相关整段逻辑提炼到新函数中，直接返回 volumeCredits，同时返回的变量命名为 result
9. 移除 format 变量，典型的将函数赋值给临时变量的场景，更愿意将其替换为一个明确声明的函数
10. format 函数名语义不太明确，起名为 usd
11. 重构目标volumeCredits，拆分循环，将volumeCredits的累加过程分离出来，这样，变量声明就可以挪动到紧邻循环的位置
12. 对 volumeCredits 的计算过程提炼函数，再应用内联变量手法内联 totalVolumeCredits 函数
13. 重复同样的步骤来移除 totalAmmount 变量，下移变量声明语句，最后再提炼函数
14. 欣赏代码全貌
15. 将 statement函数的全部内容抽取到一个新的顶层函数中，命名为 renderPlainText
16. 创建一个对象，作为两个阶段间传递的中转数据结构
17. 将顾客 customer 字段添加到中转对象里，将 perfromances 字段添加到中转对象里
18. 剧目名称信息也整合到中转数据中
19. 替换 renderPlainText中对 playFor 的所有引用点
20. 把第一阶段的代码提炼到一个独立的函数里了
 -->
