<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script>
      let plays = {
        hamlet: { name: "Hamlet", type: "tragedy" },
        "as-like": { name: "As You Like It", type: "comedy" },
        othello: { name: "Othello", type: "tragedy" },
      };
      let invoices = [
        {
          customer: "BigCo",
          performances: [
            {
              playID: "hamlet",
              audience: 55,
            },
            {
              playID: "as-like",
              audience: 35,
            },
            {
              playID: "othello",
              audience: 40,
            },
          ],
        },
      ];
      function statement(invoice, plays) {
        let totalAmount = 0;
        let volumeCredits = 0;
        let result = `Statement for ${invoice.customer}\n`;
        const format = new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: "USD",
          minimumFractionDigits: 2,
        }).format;
        for (let perf of invoice.performances) {
          const play = playFor(perf);
          let thisAmount = amountFor(perf);

          // add volume credits
          volumeCredits += Math.max(perf.audience - 30, 0);
          // add extra credit for every ten comedy attendees
          if ("comedy" === play.type)
            volumeCredits += Math.floor(perf.audience / 5);

          // print line for this order
          result += ` ${play.name}: ${format(thisAmount / 100)} (${
            perf.audience
          } seats)\n`;
          totalAmount += thisAmount;
        }
        result += `Amount owed is ${format(totalAmount / 100)}\n`;
        result += `You earned ${volumeCredits} credits\n`;
        return result;

        function amountFor(aPerformance) {
          let result = 0;

          switch (playFor(aPerformance).type) {
            case "tragedy":
              result = 40000;
              if (aPerformance.audience > 30) {
                result += 1000 * (aPerformance.audience - 30);
              }
              break;
            case "comedy":
              result = 30000;
              if (aPerformance.audience > 20) {
                result += 10000 + 500 * (aPerformance.audience - 20);
              }
              result += 300 * aPerformance.audience;
              break;
            default:
              throw new Error(`unknown type: ${playFor(aPerformance).type}`);
          }
          return result;
        }
        function playFor(aPerformance) {
          return plays[aPerformance.playID];
        }
      }
      let res = statement(invoices[0], plays);
      console.log(res);
    </script>
  </body>
</html>

<!-- 重构思路
1.中间的那段 switch，提炼到一个函数里，注意哪些变量会离开原来的作用域，其中包含thisAmout、play、perf
2. 将函数的返回值命名为 result
3. 参数取名时，使用不定冠词来标识变量的类型
4. 移出 play 变量，以查询取代临时变量
5. 移出 play 参数，首先在 amountFor 函数内部使用新提炼的函数 playFor
 -->
